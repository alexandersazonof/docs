---
title: Construção de Subgraphs no Cosmos
---

This guide is an introduction on building subgraphs indexing [Cosmos](https://cosmos.network/) based blockchains.

## O que são subgraphs no Cosmos?

The Graph permite que os programadores processem eventos em blockchain e façam dos dados resultantes facilmente disponíveis através de uma API aberta do GraphQL, conhecida como um subgraph. O [Graph Node](https://github.com/graphprotocol/graph-node) agora pode processar eventos no Cosmos, o que significa que programadores no Cosmos agora podem construir subgraphs para indexar com facilidade eventos on-chain.

Existem quatro categorias de handlers apoiados em subgraphs no Cosmos:

- **Block handlers** são executados quando um novo bloco é anexado à chain.
- **Event handlers** são executados quando um evento específico é emitido.
- **Transaction handlers** são executados quando uma transação ocorre.
- **Message handlers** são executados quando uma mensagem específica ocorre.

Baseado na [documentação oficial do Cosmos](https://docs.cosmos.network/):

> [Events](https://docs.cosmos.network/main/learn/advanced/events) are objects that contain information about the execution of the application. They are mainly used by service providers like block explorers and wallets to track the execution of various messages and index transactions.

> [Transactions](https://docs.cosmos.network/main/learn/advanced/transactions) are objects created by end-users to trigger state changes in the application.

> [Messages](https://docs.cosmos.network/main/learn/advanced/transactions#messages) are module-specific objects that trigger state transitions within the scope of the module they belong to.

Apesar de todos os dados poderem ser acessados com um block handler, outros handlers permitem a programadores de subgraphs processar dados de uma maneira muito mais granular.

## Como construir um subgraph no Cosmos

### Dependências de Subgraph

[graph-cli](https://github.com/graphprotocol/graph-tooling/tree/main/packages/cli) is a CLI tool to build and deploy subgraphs, version `>=0.30.0` is required in order to work with Cosmos subgraphs.

[graph-ts](https://github.com/graphprotocol/graph-tooling/tree/main/packages/ts) is a library of subgraph-specific types, version `>=0.27.0` is required in order to work with Cosmos subgraphs.

### Componentes Principais de Subgraph

Quando definir um subgraph, estes três componentes serão muito importantes:

**subgraph.yaml**: um arquivo YAML que contém o manifest do subgraph, além de identificar quais eventos rastrear e como processá-los.

**schema.graphql**: um schema do GraphQL que define quais dados serão armazenados para o seu subgraph, e como consultá-los via GraphQL.

**Mapeamentos de AssemblyScript**: códigos em [AssemblyScript](https://github.com/AssemblyScript/assemblyscript) que traduzem dos dados da blockchain às entidades definidas no seu schema.

### Definição de Manifest de Subgraph

O manifest do subgraph (`subgraph.yaml`) identifica as fontes de dados para o subgraph, os gatilhos de interesse, e as funções (`handlers`) que devem ser executadas em resposta àqueles gatilhos. Veja abaixo um exemplo de um manifest de subgraph para um subgraph no Cosmos:

```yaml
specVersion: 0.0.5
description: Exemplo de Subgraph no Cosmos
schema:
  file: ./schema.graphql # link ao arquivo schema
dataSources:
  - kind: cosmos
    name: CosmosHub
    network: cosmoshub-4 # Isto mudará para cada blockchain baseada no Cosmos. Neste caso, o exemplo usa a mainnet Cosmos Hub.
    source:
      startBlock: 0 # Exigido para o Cosmos, coloque o valor de 0 para começar a indexar desde o gênese da chain
    mapping:
      apiVersion: 0.0.7
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # o nome da função no arquivo de mapeamento
      eventHandlers:
        - event: rewards # o tipo de evento que será lidado
          handler: handleReward # o nome da função no arquivo de mapeamento
      transactionHandlers:
        - handler: handleTransaction # o nome da função no arquivo de mapeamento
      messageHandlers:
        - message: /cosmos.staking.v1beta1.MsgDelegate # o tipo de uma mensagem
          handler: handleMsgDelegate # o nome da função no arquivo de mapeamento
      file: ./src/mapping.ts # link ao arquivo com os mapeamentos em AssemblyScript
```

- Subgraphs no Cosmos introduzem um novo `tipo` de fonte de dados (`cosmos`).
- A rede (`network`) deve corresponder a uma chain no ecossistema Cosmos. O exemplo acima usa a mainnet do Cosmos Hub.

### Definição de Schema

Schema definition describes the structure of the resulting subgraph database and the relationships between entities. This is agnostic of the original data source. There are more details on subgraph schema definition [here](/developing/creating-a-subgraph/#the-graphql-schema).

### Mapeamentos em AssemblyScript

Os handlers para o processamento de eventos são escritos em [AssemblyScript](https://www.assemblyscript.org/).

A indexação do Cosmos introduz categorias de dados específicas ao Cosmos ao [API do AssemblyScript](/developing/assemblyscript-api/).

```tsx
class Block {
  header: Header
  evidence: EvidenceList
  resultBeginBlock: ResponseBeginBlock
  resultEndBlock: ResponseEndBlock
  transactions: Array<TxResult>
  validatorUpdates: Array<Validator>
}

class EventData {
  event: Event
  block: HeaderOnlyBlock
  tx: TransactionContext
}

class TransactionData {
  tx: TxResult
  block: HeaderOnlyBlock
}

class MessageData {
  message: Any
  block: HeaderOnlyBlock
  tx: TransactionContext
}

class TransactionContext {
  hash: Bytes
  index: u32
  code: u32
  gasWanted: i64
  gasUsed: i64
}

class HeaderOnlyBlock {
  header: Header
}

class Header {
  version: Consensus
  chainId: string
  height: u64
  time: Timestamp
  lastBlockId: BlockID
  lastCommitHash: Bytes
  dataHash: Bytes
  validatorsHash: Bytes
  nextValidatorsHash: Bytes
  consensusHash: Bytes
  appHash: Bytes
  lastResultsHash: Bytes
  evidenceHash: Bytes
  proposerAddress: Bytes
  hash: Bytes
}

class TxResult {
  height: u64
  index: u32
  tx: Tx
  result: ResponseDeliverTx
  hash: Bytes
}

class Event {
  eventType: string
  attributes: Array<EventAttribute>
}

class Any {
  typeUrl: string
  value: Bytes
}
```

Cada tipo de handler vem com a sua própria estrutura de dados, a ser passada como argumento a uma função de mapeamento.

- Handlers de blocos recebem o tipo `Block`.
- Handlers de eventos recebem o tipo `EventData`.
- Handlers de transações recebem o tipo `TransactionData`.
- Handlers de mensagens recebem o tipo `MessageData`.

Como parte do `MessageData`, o handler de mensagens recebe um contexto de transação, que contém as informações mais importantes sobre uma transação a compor uma mensagem. O contexto da transação também está disponível no tipo `EventData`, mas só quando o evento correspondente é associado a uma transação. Além disso, todos os handlers recebem uma referência a um bloco (`HeaderOnlyBlock`).

A lista completa de tipos para integração ao Cosmos está [aqui](https://github.com/graphprotocol/graph-ts/blob/4c064a8118dff43b110de22c7756e5d47fcbc8df/chain/cosmos.ts).

### Descodificação de mensagens

It's important to note that Cosmos messages are chain-specific and they are passed to a subgraph in the form of a serialized [Protocol Buffers](https://protobuf.dev/) payload. As a result, the message data needs to be decoded in a mapping function before it can be processed.

Mais informações sobre como descodificar dados de mensagem em um subgraph [aqui](https://github.com/graphprotocol/graph-tooling/blob/main/examples/cosmos-validator-delegations/src/decoding.ts).

## Criação e construção de um subgraph no Cosmos

Antes de começar a escrever os mapeamentos do subgraph, o primeiro passo é gerar os vínculos baseados nas entidades definidas no arquivo de schema do subgraph (`schema.graphql`). Assim, as funções de mapeamento criarão novos objetos destes tipos e os salvarão ao armazenamento. Isto é feito usando o seguinte comando CLI `codegen`:

```bash
$ graph codegen
```

Quando os mapeamentos estiverem prontos, o subgraph precisará ser construído. Este passo destacará quaisquer erros possíveis no manifest ou nos mapeamentos. Um subgraph deve ser construído com êxito para ser lançado ao Graph Node. Isto é possível com o seguinte comando CLI `build`:

```bash
$ graph build
```

## Lançamento de um subgraph no Cosmos

Quando o seu subgraph estiver pronto, lance o seu subgraph com o comando de CLI `graph deploy`:

**Subgraph Studio**

Visit the Subgraph Studio to create a new subgraph.

```bash
graph deploy --studio subgraph-name
```

**Local Graph Node (based on default configuration):**

```bash
graph create subgraph-name --node http://localhost:8020
```

```bash
graph deploy subgraph-name --node http://localhost:8020/ --ipfs http://localhost:5001
```

## Consulta a um subgraph no Cosmos

The GraphQL endpoint for Cosmos subgraphs is determined by the schema definition, with the existing API interface. Please visit the [GraphQL API documentation](/querying/graphql-api/) for more information.

## Apoio a Blockchains no Cosmos

### Cosmos Hub

#### O que é Cosmos Hub?

The [Cosmos Hub blockchain](https://hub.cosmos.network/) is the first blockchain in the [Cosmos](https://cosmos.network/) ecosystem. You can visit the [official documentation](https://docs.cosmos.network/) for more information.

#### Redes

Cosmos Hub mainnet is `cosmoshub-4`. Cosmos Hub current testnet is `theta-testnet-001`. <br/>Other Cosmos Hub networks, i.e. `cosmoshub-3`, are halted, therefore no data is provided for them.

### Osmosis

> Osmosis support in Graph Node and on Subgraph Studio is in beta: please contact the graph team with any questions about building Osmosis subgraphs!

#### O que é Osmosis?

[Osmosis](https://osmosis.zone/) is a decentralized, cross-chain automated market maker (AMM) protocol built on top of the Cosmos SDK. It allows users to create custom liquidity pools and trade IBC-enabled tokens. You can visit the [official documentation](https://docs.osmosis.zone/) for more information.

#### Redes

Osmosis mainnet is `osmosis-1`. Osmosis current testnet is `osmo-test-4`.

## Exemplos de Subgraphs

Here are some example subgraphs for reference:

[Block Filtering Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-block-filtering)

[Validator Rewards Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-validator-rewards)

[Validator Delegations Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-validator-delegations)

[Osmosis Token Swaps Example](https://github.com/graphprotocol/graph-tooling/tree/main/examples/cosmos-osmosis-token-swaps)
